## chapter1

#### 信息就是位+上下文

我们创建的C程序，其实是一个由0和1组成的位序列，8个位组成一个字节

#### 程序被其他程序翻译成不同格式

整个程序一共有四个阶段

- 预处理阶段，预处理器会先将#xxx这样的命令进行修改。比如#include指令，他会将这个头文件直接复制粘贴过来，修改原始的C程序，得到.i文件
- 编译阶段，编译器把.i文件翻译成一个汇编语言程序，得到.s文件
- 汇编阶段，将.s文件翻译成机器语言指令，得到.o文件，这是一个二进制文件
- 链接阶段，当我们调用别的文件里的函数，就需要合并到我们的.o程序

#### 了解编译系统如何工作是大有益处的

- 优化程序性能，虽然说现代编译器已经能帮我们生成性能很好的代码了，但是为了在C程序作出好的编码选择，我们需要了解机器代码以及编译器将不同的C语言转换为机器代码的方式
- 理解链接时出现的错误
- 避免安全漏洞

#### 系统硬件组成

- 总线，是一条贯穿整个系统的电子管道。总线被设计成传输**定长的数据块**，就是字，不同系统的字长不一样。32位系统就是4个字，字中的字节数叫字长。比如4个字节=32位，8个字节=64位
- IO设备，这是系统与外部世界的联系通道。每个IO设备都通过一个控制器或适配器与IO总线连接
- 主存，是一个临时存储设备，用来存放程序和程序处理的数据。
- 处理器，解释存储中主存中指令的引擎，处理器核心是一个大小为一个字的存储设备（寄存器），称为程序计数器（PC）。在任何时刻，PC都指向主存中某条机器语言指令

> 指令集架构：描述的是每条机器代码指令的效果
>
> 微体系结构：描述的是处理器实际上是如何实现

#### 高速缓存至关重要

前面示例我们可以观察到，系统花费了大量时间把信息从一个地方挪到另一个地方。而处理器中的寄存器容量小，速度快。主存容量大，速度慢。两者差异的增大会降低运行效率。

针对这个情况，系统设计者采用了更快更小的存储设备，称为cache。大部分分成了三级

- L1，位于处理器芯片上，容量达数万字节，访问速度接近寄存器
- L2，容量为数十万～数百万字节，通过一条特殊总线连到处理器
- L3，是一个更大的存储器。利用了高速缓存器的局部性原理（程序会访问局部区域里的数据和代码），将经常访问的数据放在高速缓存

#### 存储设备形成层次结构

更广泛的我们有L0 - L6这种多层结构。上一层的存储器，作为下一层存储器的高速缓存

#### 操作系统管理硬件

操作系统的两个基本功能：

- 防止硬件被失控的应用程序滥用
- 向应用程序提供简单一致的机制来控制复杂而又通常大不相同的低级硬件设备

系统通过了几个基本的抽象概念：

- 文件 -> IO设备
- 虚拟内存 -> 主存+磁盘IO设备
- 进程 -> 处理器，主存，IO设备

#### 进程

进程是**操作系统对一个正在运行的程序的一种抽象**，在一个系统上可以同时运行多个进程，而每个进程都好像在独占地使用硬件。

并发运行，则是表示一个进程的指令和另一个进程的指令是交错执行的

在大多数系统中，进程书是多于运行它们的CPU个数。单核系统一个时刻只能执行一个程序，而多核系统能够执行多个程序。

处理器通过进程之间的切换（这种机制也称为上下文切换），来让cpu看起来像是并发执行多个进程

操作系统保持跟踪进程运行所需的所有状态信息，这些状态也就是上下文，包括了很多信息，如PC（程序计数器）和寄存器文件当前值，主存内容 。

当操作系统要把控制权转移到别的进程时，会进行上下文切换：

- 保存当前进程的上下文
- 恢复新进程的上下文
- 控制权转移到新进程

#### 线程

一个进程中由多个线程组成，每个线程**运行在进程的上下文中，共享同样的代码和全局数据**

#### 虚拟内存

它为每个进程提供了一个假象，即每个进程都在独占地使用主存。

每个进程看到的内存都是一致的，称为虚拟地址空间

我们对地址由低到高来介绍：

- 程序代码和数据，对所有进程来说，代码是从同一固定地址开始，紧接着的是和C全局变量相对应的数据位置。
- 堆。当调用malloc和free这些操作的时候，堆会在运行时动态地扩展和收缩
- 共享库。一块用来存放C标准库和数学库这样的共享库的代码和数据的区域
- 栈。编译器用它来实现函数调用，当调用一个函数时，栈会增长，从一个函数返回，栈会收缩
- 内核虚拟内存。应用程序无权限读取/调用，必须调用内核来执行这些操作

#### 并发和并行

强调三个层次：

#### 线程级并发

其构建在进程这个抽象上，在一个进程中执行多个控制流。

（在单核上）这只是模拟出来的并发，其实是CPU在执行的线程间快速切换来实现的

随着多核和超线程出现，每个核心有自己的L1 L2缓存，共享一个L3缓存。

超线程有时称为同时多线程，允许一个CPU执行多个控制流。它可以在单个周期的基础上决定执行哪个线程

#### 指令级并行

现代处理器可以同时执行多条指令的属性称为指令级并行

#### 单指令，多数据并行

即SIMD

